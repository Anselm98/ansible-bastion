# PKI Role

This Ansible role creates a Public Key Infrastructure (PKI) for generating SSL/TLS certificates including a Certificate Authority (CA) and server certificates.

## Description

This role establishes a complete PKI setup for SSL/TLS certificate management. It:

- Installs OpenSSL package
- Creates PKI directory structure with proper permissions
- Generates a Certificate Authority (CA) private key and certificate
- Creates server private key and certificate signed by the CA
- Sets up symlinks for nginx integration
- Configures proper file permissions for security

## Requirements

- Linux system with OpenSSL support
- sudo privileges for installation and configuration

## Variables

This role uses template files for certificate configuration. The following variables can be customized in your inventory or playbook:

| Variable | Default | Description |
|----------|---------|-------------|
| Certificate configuration options | See templates | Configured via ca.conf.j2 and server.conf.j2 templates |

## Example Usage

### Basic Usage

```yaml
- hosts: servers
  become: yes
  roles:
    - pki
```

### In Playbook

```yaml
---
- name: Set up SSL Certificates
  hosts: bastion
  become: yes
  roles:
    - pki
    - nginx  # Uses certificates generated by PKI role
```

## Files and Directories

After installation, the following directory structure is created:

### PKI Structure
- `/etc/pki/` - Main PKI directory
- `/etc/pki/ca/` - Certificate Authority files
- `/etc/pki/ca/private/` - CA private key (mode 700)
- `/etc/pki/ca/certs/` - CA certificate
- `/etc/pki/server/` - Server certificate files
- `/etc/pki/server/private/` - Server private key (mode 700)
- `/etc/pki/server/certs/` - Server certificate

### Generated Files
- `/etc/pki/ca/private/ca.key` - CA private key (4096-bit RSA)
- `/etc/pki/ca/certs/ca.crt` - CA certificate (10-year validity)
- `/etc/pki/server/private/server.key` - Server private key (2048-bit RSA)
- `/etc/pki/server/certs/server.crt` - Server certificate (1-year validity)

### Nginx Integration
- `/etc/ssl/certs/nginx-selfsigned.crt` - Symlink to server certificate
- `/etc/ssl/private/nginx-selfsigned.key` - Symlink to server private key

## Certificate Details

### Certificate Authority (CA)
- 4096-bit RSA private key
- 10-year validity period
- Self-signed root certificate
- Used to sign server certificates

### Server Certificate
- 2048-bit RSA private key
- 1-year validity period
- Signed by the CA
- Includes Subject Alternative Names (SAN) for flexibility

## Security Features

- Private keys are stored with 600 permissions (root only)
- Private directories have 700 permissions
- Certificates have 644 permissions for reading
- Secure key generation using OpenSSL

## Certificate Management

### Manual Certificate Operations

```bash
# View CA certificate details
sudo openssl x509 -in /etc/pki/ca/certs/ca.crt -text -noout

# View server certificate details
sudo openssl x509 -in /etc/pki/server/certs/server.crt -text -noout

# Verify server certificate against CA
sudo openssl verify -CAfile /etc/pki/ca/certs/ca.crt /etc/pki/server/certs/server.crt

# Check certificate expiration
sudo openssl x509 -in /etc/pki/server/certs/server.crt -noout -dates
```

## Integration with Other Roles

This role is designed to work with:
- `nginx` role - Provides SSL certificates for web server
- Any service requiring SSL/TLS certificates

## Notes

- This role is idempotent and will not regenerate existing certificates
- All certificates are self-signed (suitable for internal use)
- For production environments, consider using certificates from a trusted CA
- The role creates all necessary directory structures and symlinks
- Private keys are generated with appropriate bit lengths for security
- Certificate validity periods can be customized in the configuration templates 